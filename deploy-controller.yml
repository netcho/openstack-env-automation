- name: Bootstrapping OpenStack hosts
  hosts: openstack_controllers,nova_compute
  become_method: sudo
  roles:
    - name: openstack_hosts
      become: yes
      vars:
        openstack_host_manage_deploy_hosts_file: no

- name: Deploying Galera cluster
  hosts: galera_all
  become_method: sudo
  roles:
    - name: galera_server
      become: yes
      vars:
        galera_install_server: true
        galera_server_bind_address: 0.0.0.0

- name: Deploying RabbitMQ cluster
  hosts: rabbitmq_all
  become_method: sudo
  roles:
    - name: rabbitmq_server
      become: yes
  vars:
    openstack_pki_setup_host: "{{ groups['rabbitmq_all'][0] }}"

- name: Installing memcached
  hosts: memcached
  become_method: sudo
  roles:
    - name: memcached_server
      become: yes

- import_playbook: utility-install.yml
- import_playbook: certificate-ssh-authority.yml

- name: Installing Keystone
  hosts: keystone_all
  become: yes
  pre_tasks:
    - name: "Pre-service deployment tasks from os_keystone role"
      include_role:
        name: os_keystone
        tasks_from: main_pre.yml
      vars:
        keystone_ssh_keypairs_setup_host: "{{ groups['keystone_all'][0] }}"
  roles:
    - name: os_keystone
  vars:
    keystone_user_pip_packages:
      - python-binary-memcached
  vars_files:
    - "defaults/{{ install_method }}_install.yml"

- name: Installing Glance
  hosts: glance_all
  roles:
    - name: os_glance
      become: yes
  vars_files:
    - "defaults/{{ install_method }}_install.yml"
  tags:
    - glance

- name: Installing Nova control plane
  import_playbook: common-playbooks/nova.yml
  vars:
    nova_hosts: "nova_conductor:nova_scheduler:nova_api_os_compute:nova_api_metadata:nova_console"

- name: Install Nova compute agents
  import_playbook: common-playbooks/nova.yml
  vars:
    nova_hosts: "nova_compute:!nova_conductor:!nova_scheduler:!nova_api_os_compute:!nova_api_metadata:!nova_console"
